\chapter{Implementation}\label{chapter:implementation}

This chapter contains detailed information on the rationale and how solutions
are implemented. It also gives instructions on how to install them. It assumes
the reader has ssh access to the server, sudo privileges, access to the source
code and has cloned the code repository on the server as detailed in appendix
\ref{chapter:code}.

\section{Existing Data Visualization Service}

The existing service, as detailed in~\cite{nowak2024pvw}, provides a web-based
framework for sharing and visualizing research data. The visualization
functionality leverages Kitware's ParaViewWeb Framework for browser-based remote
rendering. The ParaView-like web application allows users to directly visualize
simulation results interactively in their web browser without the need to
download large datasets. The service is realized on a LRZ Compute Cloud (CC)
instance serving ParaView Visualizer and an Apache HTTP server functioning as a
reverse proxy.

It seamlessly integrates with LRZ's Data Science Storage (DSS) as it is
connected to the CC instance via an NFS mount. Users can share specific folders
from their personal DSS directory with external researchers who do not have
direct access to the LRZ. This is achieved through unique access links, similar
to file-sharing services like Google Drive or Dropbox.

\subsection{Fixing ParaView OSMesa and glibc Isse}

In February Ubuntu 22.04 LTS upgraded its GNU C Library, commonly known as
\textit{glibc}, to version 2.35. This broke the existing data visualization
service as the used ParaView Server is incompatible with the upgraded
\textit{glibc}. The underlying problem is the \textit{OSMesa} binary used by
ParaView for software rendering and is further described in this GitLab
Issue~\cite{kitwareOsmesaBinary}. Until this report's submission date there has
not been a fix for thi issue.

As proposed by the ParaView maintainers in~\cite{paraviewUsingUbuntu}
workarounds for this bug are

\begin{enumerate}
    \item Using \textit{EGL} flavor of ParaView Server
    \item Compiling ParaView with \textit{OSMesa} locally
    \item Downgrading \textit{glibc}
\end{enumerate}

Option 1 requires a CC instance with a graphics card as the \textit{EGL} variant
uses hardware rendering. However as currently the demand for GPUs is
unquestionably high, they are no instances with GPU available. Option 2 is an
involved task with software projects of considerable size as in the case of
ParaView, making it also infeasible. Thus, we have decided on option 3 by
setting up a new CC instance running on Ubuntu 20.04 LTS that comes with
\textit{glibc} version 2.31 and installing the data visualization service again.
This is because \textit{glibc} is a very common dependency and downgrading it in
a live system would lead to further incompatibilities with other software.

\subsubsection*{Instructions for the workaround}

For the most part appendix B (Anleitung zur Bereitstellung)
of~\cite{nowak2024pvw} can be followed to install the existing service and
helper scripts on a new CC instance. Note that as the source code is not
publicly available anymore instead of using curl to download needed files, we
assume the reader already has every file needed by cloning the code repository.
After following appendix~\ref{chapter:code} to do so, the reader would need to
change to the directory that contains needed files. 

For example instead of
\begin{terminal}
    curl -fSLOJ https://raw.githubusercontent.com/FabianNowak/pv-visualizer-multi-project-config/releases/<directory>/<needed-file>
\end{terminal}

The following suffices
\begin{terminal}
    cd <directory>
\end{terminal}

The custom executable \lstinline{pv-session-mapper} written in Rust has to be
compiled locally as \textit{glibc} is dynamically linked. This means at section
\textbf{pv-session-mapper installieren} follow these instruction instead

\begin{enumerate}
    \item First install Rust and its build system Cargo by using \textit{rustup}
    \begin{terminal}
        curl https://sh.rustup.rs -sSf | sh
    \end{terminal}
    It will download a script, and start the installation. If everything went
    well \lstinline{Rust is installed now. Great!} should appear.
    \item Change into source directory and compile locally
    \begin{terminal}
        cd pv-session-mapper/session_mapper
        cargo build --release
    \end{terminal}
    \item Create target directory, copy and adjust custom binary
    \begin{terminal}
        sudo mkdir /opt/pv-session-mapper
        sudo cp target/release/pv-session-mapper /opt/pv-session-mapper
        sudo chown root:root /opt/pv-session-mapper/pv-session-mapper
        sudo chmod +x /opt/pv-session-mapper/pv-session-mapper
    \end{terminal}
\end{enumerate}

Once through the tutorial, these final adjustments on the Apache Server have to
be made

\begin{enumerate}
    \item Activate Apache Server module \lstinline{proxy_wstunnel} with 
    \begin{terminal}
        sudo a2enmod proxy_wstunnel
    \end{terminal}
    \item Restart Apache Server to load new configuration with
    \begin{terminal}
        sudo systemctl restart apache2
    \end{terminal}
\end{enumerate}

\subsection{Reorganizing Apache HTTP Server configuration}

The existing data visualization service will need a publicly accessible landing
page and a protected new user portal after SSO login via DFN-AAI was successful.
It is best practice to separate the web app i.e. ParaViewWeb from the marketing
site. Benefits are that non-technical staff can independently modify content of
the landing page without possibly breaking the web app. One way to achieve a
separation is with the help of subdomains. 

In our design, the landing page will be reachable under
\lstinline{marge.aer.ed.tum.de} whereas the service will be bound to the
subdomain \lstinline{pvw.marge.aer.ed.tum.de}. This setup also simplifies DNS
configuration, the system responsible for translating human-readable names to
actual routable IP-addresses, as only two records are needed. An A-Record for
linking \lstinline{marge.aer.ed.tum.de} to the CC instance's floating IP-address
as well as a wildcard DNS record linking \lstinline{*.marge.aer.ed.tum.de} to
the same IP-address. The wildcard record will match for every subdomain, even
not yet existing ones, making this setup suitable for future requirements. 

In order to achieve aforementioned behavior, Apache's virtual host feature is
leveraged, allowing different content to be served over the same Apache server,
depending on the host name used in the request. ParaViewWeb continues to use its
existing subdirectory whereas the landing page is served from a new
subdirectory.

This means the existing \lstinline{paraview-multi-user.conf} is to be moved from
\lstinline{conf-available} to \lstinline{sites-available}, the usual place where
virtual configurations are placed, slightly changed to account for the subdomain
as seen in Listing~\ref{lst:002-pvw} and a new landing page configuration shown
in Listing~\ref{lst:001-marge} is to be added. Note how Apache resolves which
virtual host to serve with the help of the configured \lstinline{ServerName}.

The new landing page configuration resembles a standard site configuration and
is constructed in the following way:
\begin{itemize}
    \item Virtual host configurations are enclosed in a \lstinline{<VirtualHost>}
    directive, meaning that everything nested within only applies to the defined
    VirtualHost.
    \item In line 2, \lstinline{ServerName} specifies under which name the
    landing page is accessible.
    \item \lstinline {DocumentRoot} in line 5 specifies which directory serves
    the landing page's content.
    \item \lstinline{ErrorLog} and \lstinline{CustomLog} define in which
    location the virtual host's error and access logs are saved.
    \lstinline{APACHE_LOG_DIR} is a provided variable and resolves to the
    standard location \lstinline{/var/log/apache2}.
    \item Lines 10-14 allow the Apache server to access the files provided in
    line 5.
\end{itemize}

\lstinputlisting[
    style=sourcecode,
    float=htp,
    label={lst:001-marge},
    caption={\lstinline|001-marge.conf|: Apache configuration for Landing Page}
]{../apache-config/sites-available/001-marge.conf}

The changes made to ParaViewWeb's Apache configuration are minor and consist of
enclosing the configuration in a \lstinline{<VirtualHost>} directive,  in line 2
and specifying an own subdirectory \lstinline{/var/log/apache2/pvw} for storing
the web app's Apache logs in line 12-13 to separate concerns.

\lstinputlisting[
    style=sourcecode,
    float=htp,
    label={lst:002-pvw},
    caption={\lstinline{002-pvw.conf}: Apache configuration for ParaViewWeb}
]{../apache-config/sites-available/002-pvw.conf}

\subsubsection*{Instructions}

\begin{enumerate}
    \item Create a folder to serve files for landing page
    \lstinline{marge.aer.ed.tum.de}
    \begin{terminal}
        sudo mkdir /var/www/html/marge
    \end{terminal}
    \item Create a folder to store ParaViewWeb's log files
    \begin{terminal}
        sudo mkdir /var/log/apache2/pvw
    \end{terminal}
    \item Adjust \lstinline{pv-configurator} settings to reflect ParaViewWeb
    subdomain. Open and edit \lstinline{configurator_settings.json} with root
    privileges
    \begin{terminal}
        sudo vim /srv/pv-configurator/configurator_settings.json
    \end{terminal}
    \item Make following change and save file
    \begin{lstlisting}[frame=single]
        {
            "servername": "pvw.marge.aer.ed.tum.de",
            ...
        }
    \end{lstlisting}
    \item Change into configuration directory and copy both into apache
    configuration
    \begin{terminal}
        cd apache-config/sites-available
        sudo cp 001-marge.conf /etc/apache2/sites-available
        sudo cp 002-pvw.conf /etc/apache2/sites-available
    \end{terminal}
    \item Deactivate old ParaViewWeb Apache configuration
    \begin{terminal}
        sudo a2disconf paraview-multi-project
    \end{terminal}
    At this point \lstinline{paraview-multi-project.conf} could be deleted as it
    is no longer used.
    \item Finally activate new configuration and restart Apache server
    \begin{terminal}
        sudo a2ensite 001-marge
        sudo a2ensite 002-pvw
        sudo systemctl restart apache2
    \end{terminal}
\end{enumerate}

\section{Creating a New User Portal}



\subsection{Adding Logging}

\section{Installing and Configuring Shibboleth SP}\label{section:shibboleth}

